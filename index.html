<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-clinic-medical"></i> MedCare</h2>
        </div>
        <div class="sidebar-menu">
            <a href="index.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="patients.html" class="menu-item">
                <i class="fas fa-user-injured"></i>
                <span>Patients</span>
            </a>
            <a href="appointments.html" class="menu-item">
                <i class="fas fa-calendar-check"></i>
                <span>Appointments</span>
            </a>
            <a href="records.html" class="menu-item">
                <i class="fas fa-file-medical"></i>
                <span>Records</span>
            </a>
            <a href="chat.html" class="menu-item">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </a>
            <a href="admin.html" class="menu-item admin-only" style="display: none;">
                <i class="fas fa-user-shield"></i>
                <span>Admin</span>
            </a>
            <a href="settings.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            <a href="#" class="menu-item logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
            </div>
            <div class="header-actions">
                    <button class="btn btn-primary" onclick="window.location.href='patients.html'">
                        <i class="fas fa-plus"></i> New Patient
                    </button>
                    <button class="btn" onclick="window.location.href='appointments.html'">
                        <i class="fas fa-calendar-plus"></i> New Appointment
                    </button>
                    <div class="user-profile">
                        <div class="user-profile-pic">
                            <i class="fas fa-user-circle" style="font-size: 1.8rem; color: var(--primary);"></i>
                        </div>
                        <span id="user-display-name">User</span>
                    </div>
                </div>
        </div>

        <!-- Today's Stats -->
        <div class="panel">
            <h3>Today's Stats</h3>
            <div class="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="stat-card">
                    <span class="stat-label">Total Appointments</span>
                    <span class="stat-value" id="total-appointments">0</span>
                    <span class="text-muted">Today</span>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--secondary);">
                    <span class="stat-label">Completed</span>
                    <span class="stat-value" id="completed-appointments">0</span>
                    <span class="text-success" id="completed-percentage">0% completed</span>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--warning);">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value" id="pending-appointments">0</span>
                    <span class="text-warning" id="overdue-count">0 overdue</span>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <span class="stat-label">Cancellations</span>
                    <span class="stat-value" id="cancelled-appointments">0</span>
                    <span class="text-danger" id="cancelled-percentage">0% cancelled</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Upcoming Patients -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Upcoming Patients</h3>
                    <a href="appointments.html" class="btn btn-sm">View All</a>
                </div>
                <ul class="patient-list">
                    <!-- Patient items would be here -->
                </ul>
            </div>

            <!-- Next Patient Vitals -->
            <div class="panel">
                <div class="panel-header">
                    <h3>Next Patient Vitals</h3>
                    <a href="records.html" class="btn btn-sm btn-outline">Full History</a>
                </div>
                <div class="patient-profile" id="next-patient-profile">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--gray);"></i>
                        <p style="margin-top: 10px;">No upcoming patients</p>
                    </div>
                </div>
                <div class="vitals-grid" id="next-patient-vitals" style="display: none;">
                    <div class="vital-card">
                        <div class="vital-icon"><i class="fas fa-heartbeat"></i></div>
                        <div class="vital-value" id="vital-heart-rate">--</div>
                        <div class="vital-label">Heart Rate</div>
                    </div>
                    <div class="vital-card">
                        <div class="vital-icon"><i class="fas fa-stethoscope"></i></div>
                        <div class="vital-value" id="vital-blood-pressure">--/--</div>
                        <div class="vital-label">Blood Pressure</div>
                    </div>
                    <div class="vital-card">
                        <div class="vital-icon"><i class="fas fa-thermometer-half"></i></div>
                        <div class="vital-value" id="vital-temperature">--</div>
                        <div class="vital-label">Temperature</div>
                    </div>
                    <div class="vital-card">
                        <div class="vital-icon"><i class="fas fa-lungs"></i></div>
                        <div class="vital-value" id="vital-respiratory-rate">--</div>
                        <div class="vital-label">Respiratory Rate</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Overview -->
        <div class="panel">
            <div class="panel-header">
                <h3>Weekly Patient Overview</h3>
                <div>
                    <button class="btn btn-sm btn-outline">This Week</button>
                    <button class="btn btn-sm">Export</button>
                </div>
            </div>
            <div class="charts-container">
                <div class="chart-card">
                    <h4 class="mb-3">Appointments This Week</h4>
                    <canvas id="appointmentsChart" height="250"></canvas>
                </div>
                <div class="chart-card">
                    <h4 class="mb-3">Patient Demographics</h4>
                    <canvas id="demographicsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // Setup dashboard data
            setupDashboard();
        });
        
        function setupDashboard() {
            // Load upcoming appointments
            loadUpcomingAppointments();
            
            // Load next patient vitals
            loadNextPatientVitals();
            
            // Initialize charts
            initializeCharts();
        }
        
        function loadNextPatientVitals() {
            const nextPatientProfile = document.getElementById('next-patient-profile');
            const nextPatientVitals = document.getElementById('next-patient-vitals');
            const heartRate = document.getElementById('vital-heart-rate');
            const bloodPressure = document.getElementById('vital-blood-pressure');
            const temperature = document.getElementById('vital-temperature');
            const respiratoryRate = document.getElementById('vital-respiratory-rate');
            
            if (!nextPatientProfile || !nextPatientVitals) return;
            
            // Get appointments and records from localStorage
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const records = JSON.parse(localStorage.getItem('records')) || [];
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            
            // Get current date and time
            const now = new Date();
            
            // Find the next scheduled appointment
            const upcomingAppointments = appointments.filter(appt => {
                const apptDate = new Date(appt.date);
                const apptTime = appt.time.split(':');
                apptDate.setHours(parseInt(apptTime[0]), parseInt(apptTime[1]), 0, 0);
                return apptDate > now && appt.status === 'Scheduled';
            });
            
            // Sort by date (closest first)
            upcomingAppointments.sort((a, b) => {
                const dateA = new Date(a.date);
                const timeA = a.time.split(':');
                dateA.setHours(parseInt(timeA[0]), parseInt(timeA[1]), 0, 0);
                
                const dateB = new Date(b.date);
                const timeB = b.time.split(':');
                dateB.setHours(parseInt(timeB[0]), parseInt(timeB[1]), 0, 0);
                
                return dateA - dateB;
            });
            
            // If no upcoming appointments, show default message
            if (upcomingAppointments.length === 0) {
                nextPatientProfile.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--gray);"></i>
                        <p style="margin-top: 10px;">No upcoming patients</p>
                    </div>
                `;
                nextPatientVitals.style.display = 'none';
                return;
            }
            
            // Get the next appointment
            const nextAppointment = upcomingAppointments[0];
            
            // Find the patient
            const patient = patients.find(p => p.id === nextAppointment.patientId);
            
            if (!patient) {
                nextPatientProfile.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning);"></i>
                        <p style="margin-top: 10px;">Patient data not found</p>
                    </div>
                `;
                nextPatientVitals.style.display = 'none';
                return;
            }
            
            // Format appointment date and time
            const apptDate = new Date(nextAppointment.date);
            const isToday = apptDate.toDateString() === now.toDateString();
            const dateDisplay = isToday ? 'Today' : apptDate.toLocaleDateString();
            
            // Update patient profile
            nextPatientProfile.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px;">
                    <div style="flex-shrink: 0; margin-right: 15px;">
                        <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <div>
                        <h4 style="margin: 0; font-size: 1.2rem;">${patient.firstName} ${patient.lastName}</h4>
                        <p style="margin: 5px 0; color: var(--gray); font-size: 0.9rem;">${patient.gender}, ${patient.dob}</p>
                        <div style="margin-top: 8px;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background-color: var(--light-primary); color: var(--primary);">
                                ${dateDisplay} at ${nextAppointment.time}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            // Find the most recent vital signs record for this patient
            const vitalRecords = records.filter(record => 
                record.patientId === patient.id && 
                record.recordType === 'Vital Signs'
            );
            
            // Sort by date (most recent first)
            vitalRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // If no vital records, show default values
            if (vitalRecords.length === 0) {
                nextPatientVitals.style.display = 'grid';
                return; // Keep the default -- values
            }
            
            // Get the most recent vital record
            const latestVitals = vitalRecords[0];
            
            // Update vital signs
            heartRate.textContent = latestVitals.heartRate || '--';
            bloodPressure.textContent = latestVitals.bloodPressure || '--/--';
            temperature.textContent = latestVitals.temperature || '--';
            respiratoryRate.textContent = latestVitals.respiratoryRate || '--';
            
            // Show vitals grid
            nextPatientVitals.style.display = 'grid';
        }
        
        function loadUpcomingAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const patientList = document.querySelector('.patient-list');
            
            // Clear existing items
            patientList.innerHTML = '';
            
            // Filter for upcoming appointments (today and future)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingAppointments = appointments.filter(appt => {
                const apptDate = new Date(appt.date);
                return apptDate >= today && appt.status === 'Scheduled';
            });
            
            // Sort by date (closest first)
            upcomingAppointments.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Display up to 5 appointments
            const displayAppointments = upcomingAppointments.slice(0, 5);
            
            if (displayAppointments.length === 0) {
                patientList.innerHTML = '<li style="padding: 15px; text-align: center;">No upcoming appointments</li>';
                return;
            }
            
            displayAppointments.forEach(appt => {
                const li = document.createElement('li');
                li.style.padding = '10px 15px';
                li.style.borderBottom = '1px solid var(--light-gray)';
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.justifyContent = 'space-between';
                
                // Format date for display
                const apptDate = new Date(appt.date);
                const isToday = apptDate.toDateString() === new Date().toDateString();
                const dateDisplay = isToday ? 'Today' : apptDate.toLocaleDateString();
                
                li.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${appt.patientName}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">${dateDisplay} at ${appt.time}</div>
                    </div>
                    <div>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background-color: var(--primary); color: white;">
                            ${appt.reason}
                        </span>
                    </div>
                `;
                
                patientList.appendChild(li);
            });
        }
        
        function initializeCharts() {
            // Get appointments from localStorage
            const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
            const patients = JSON.parse(localStorage.getItem('patients')) || [];
            
            // Get current week's appointments
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ...
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Start from Monday
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // End on Sunday
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Filter appointments for current week
            const weekAppointments = appointments.filter(appt => {
                const apptDate = new Date(appt.date);
                return apptDate >= startOfWeek && apptDate <= endOfWeek;
            });
            
            // Count appointments by day of week
            const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const appointmentsByDay = Array(7).fill(0);
            
            weekAppointments.forEach(appt => {
                const apptDate = new Date(appt.date);
                const dayIndex = (apptDate.getDay() + 6) % 7; // Convert to 0 = Monday, ..., 6 = Sunday
                appointmentsByDay[dayIndex]++;
            });
            
            // Appointments Chart
            const appointmentsCtx = document.getElementById('appointmentsChart').getContext('2d');
            new Chart(appointmentsCtx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Appointments',
                        data: appointmentsByDay,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Count patients by gender
            let maleCount = 0;
            let femaleCount = 0;
            
            patients.forEach(patient => {
                if (patient.gender === 'Male') {
                    maleCount++;
                } else if (patient.gender === 'Female') {
                    femaleCount++;
                }
            });
            
            // Demographics Chart
            const demographicsCtx = document.getElementById('demographicsChart').getContext('2d');
            new Chart(demographicsCtx, {
                type: 'pie',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        label: 'Gender Distribution',
                        data: [maleCount, femaleCount],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 99, 132, 0.5)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            });
        }
    </script>
</body>
</html>